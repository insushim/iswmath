// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== 사용자 관련 ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String?
  role          UserRole  @default(STUDENT)
  avatar        Json?     // 캐릭터 커스터마이징 데이터
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  student       Student?
  parent        Parent?
  teacher       Teacher?
  accounts      Account[]
  sessions      Session[]
}

enum UserRole {
  STUDENT
  PARENT
  TEACHER
  ADMIN
}

model Student {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id])

  // 학년 정보
  gradeLevel        Int      // 1~12 (초1~고3)
  schoolType        SchoolType

  // 진단 결과
  currentMathLevel  Float    @default(0) // 0.0 ~ 12.0
  lastDiagnosticAt  DateTime?

  // 게이미피케이션
  totalXP           Int      @default(0)
  currentLevel      Int      @default(1)
  coins             Int      @default(0)
  streak            Int      @default(0)
  longestStreak     Int      @default(0)
  lastActiveAt      DateTime @default(now())

  // Relations
  progress          Progress[]
  achievements      StudentAchievement[]
  problemAttempts   ProblemAttempt[]
  learningPaths     LearningPath[]
  dailyGoals        DailyGoal[]
  parentConnections ParentStudent[]
  classEnrollments  ClassStudent[]
}

enum SchoolType {
  ELEMENTARY  // 초등학교
  MIDDLE      // 중학교
  HIGH        // 고등학교
}

model Parent {
  id       String   @id @default(cuid())
  userId   String   @unique
  user     User     @relation(fields: [userId], references: [id])

  children ParentStudent[]
}

model ParentStudent {
  id        String   @id @default(cuid())
  parentId  String
  studentId String
  parent    Parent   @relation(fields: [parentId], references: [id])
  student   Student  @relation(fields: [studentId], references: [id])

  @@unique([parentId, studentId])
}

model Teacher {
  id       String   @id @default(cuid())
  userId   String   @unique
  user     User     @relation(fields: [userId], references: [id])
  school   String?

  classes  Class[]
}

model Class {
  id          String   @id @default(cuid())
  name        String
  teacherId   String
  teacher     Teacher  @relation(fields: [teacherId], references: [id])
  gradeLevel  Int

  students    ClassStudent[]
  assignments Assignment[]
}

model ClassStudent {
  id        String   @id @default(cuid())
  classId   String
  studentId String
  class     Class    @relation(fields: [classId], references: [id])
  student   Student  @relation(fields: [studentId], references: [id])

  @@unique([classId, studentId])
}

// ==================== 교육과정 및 개념 ====================

model Subject {
  id          String    @id @default(cuid())
  name        String    // 수와 연산, 도형, 측정, 규칙성, 자료와 가능성
  description String?

  domains     Domain[]
}

model Domain {
  id          String    @id @default(cuid())
  subjectId   String
  subject     Subject   @relation(fields: [subjectId], references: [id])
  name        String    // 예: 자연수의 덧셈과 뺄셈
  gradeStart  Int       // 시작 학년
  gradeEnd    Int       // 종료 학년

  concepts    Concept[]
}

model Concept {
  id              String    @id @default(cuid())
  domainId        String
  domain          Domain    @relation(fields: [domainId], references: [id])

  name            String    // 예: 받아올림이 있는 덧셈
  description     String
  gradeLevel      Int       // 해당 학년
  semester        Int       // 1 or 2
  orderIndex      Int       // 학습 순서

  // 난이도 메타데이터
  difficultyBase  Float     @default(1.0) // 기본 난이도 (1.0~10.0)
  estimatedTime   Int       @default(30)  // 예상 학습 시간 (분)

  // AI 학습용 메타데이터
  keywords        String[]  // 관련 키워드
  commonMistakes  String[]  // 흔한 오류 유형

  // Relations
  prerequisites   ConceptPrerequisite[] @relation("ConceptToPrerequisite")
  dependents      ConceptPrerequisite[] @relation("PrerequisiteToConcept")
  lessons         Lesson[]
  problems        Problem[]
  progress        Progress[]
}

model ConceptPrerequisite {
  id              String   @id @default(cuid())
  conceptId       String
  prerequisiteId  String
  importance      Float    @default(1.0) // 0.0~1.0 (필수도)

  concept         Concept  @relation("ConceptToPrerequisite", fields: [conceptId], references: [id])
  prerequisite    Concept  @relation("PrerequisiteToConcept", fields: [prerequisiteId], references: [id])

  @@unique([conceptId, prerequisiteId])
}

// ==================== 학습 콘텐츠 ====================

model Lesson {
  id          String    @id @default(cuid())
  conceptId   String
  concept     Concept   @relation(fields: [conceptId], references: [id])

  title       String
  content     Json      // 리치 콘텐츠 (텍스트, 이미지, 비디오 등)
  orderIndex  Int
  type        LessonType

  // 인터랙티브 요소
  hasVideo        Boolean @default(false)
  hasInteractive  Boolean @default(false)
  hasManipulative Boolean @default(false) // 가상 교구
}

enum LessonType {
  INTRODUCTION    // 개념 도입
  EXPLANATION     // 개념 설명
  EXAMPLE         // 예제
  PRACTICE        // 연습
  APPLICATION     // 응용
  SUMMARY         // 정리
}

model Problem {
  id          String    @id @default(cuid())
  conceptId   String
  concept     Concept   @relation(fields: [conceptId], references: [id])

  // 문제 내용
  content     Json      // 문제 텍스트 (LaTeX 포함)
  type        ProblemType
  difficulty  Float     // 1.0 ~ 10.0

  // 정답 및 해설
  answer      Json      // 정답 (다양한 형식 지원)
  solution    Json      // 풀이 과정
  hints       Json[]    // 단계별 힌트

  // 메타데이터
  tags        String[]
  source      String?   // 출처
  isGenerated Boolean   @default(false) // AI 생성 여부

  // 통계
  avgAttempts     Float   @default(0)
  avgTimeSeconds  Float   @default(0)
  correctRate     Float   @default(0)

  attempts    ProblemAttempt[]
}

enum ProblemType {
  MULTIPLE_CHOICE   // 객관식
  SHORT_ANSWER      // 단답형
  FILL_BLANK        // 빈칸 채우기
  TRUE_FALSE        // 참/거짓
  MATCHING          // 짝짓기
  ORDERING          // 순서 배열
  GRAPH_PLOT        // 그래프 그리기
  PROOF             // 증명
  WORD_PROBLEM      // 서술형/문장제
}

// ==================== 학습 진행 ====================

model Progress {
  id          String    @id @default(cuid())
  studentId   String
  conceptId   String
  student     Student   @relation(fields: [studentId], references: [id])
  concept     Concept   @relation(fields: [conceptId], references: [id])

  // 학습 상태
  status      ProgressStatus @default(NOT_STARTED)
  mastery     Float          @default(0) // 0.0 ~ 1.0

  // 통계
  totalAttempts     Int   @default(0)
  correctAttempts   Int   @default(0)
  totalTimeSeconds  Int   @default(0)

  // 적응형 학습 데이터
  currentDifficulty Float @default(1.0)
  consecutiveCorrect Int  @default(0)
  consecutiveWrong   Int  @default(0)

  lastStudiedAt     DateTime?
  masteredAt        DateTime?

  @@unique([studentId, conceptId])
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  NEEDS_REVIEW
  MASTERED
}

model ProblemAttempt {
  id          String    @id @default(cuid())
  studentId   String
  problemId   String
  student     Student   @relation(fields: [studentId], references: [id])
  problem     Problem   @relation(fields: [problemId], references: [id])

  // 시도 정보
  userAnswer  Json
  isCorrect   Boolean
  timeSeconds Int
  hintsUsed   Int       @default(0)

  // AI 평가
  aiEvaluation Json?    // Gemini 평가 결과
  errorType    String?  // 오류 유형 분류

  // XP 및 보상
  xpEarned    Int       @default(0)

  createdAt   DateTime  @default(now())
}

model LearningPath {
  id          String    @id @default(cuid())
  studentId   String
  student     Student   @relation(fields: [studentId], references: [id])

  name        String
  description String?
  isActive    Boolean   @default(true)

  // 추천된 개념 순서
  conceptSequence String[] // Concept IDs
  currentIndex    Int      @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ==================== 게이미피케이션 ====================

model Achievement {
  id          String    @id @default(cuid())
  code        String    @unique
  name        String
  description String
  category    AchievementCategory

  // 달성 조건
  condition   Json      // 달성 조건 정의

  // 보상
  xpReward    Int       @default(0)
  coinReward  Int       @default(0)
  badgeImage  String?

  // 희귀도
  rarity      Rarity    @default(COMMON)

  students    StudentAchievement[]
}

enum AchievementCategory {
  LEARNING      // 학습 관련
  STREAK        // 연속 학습
  MASTERY       // 개념 마스터
  SPEED         // 속도
  ACCURACY      // 정확도
  SOCIAL        // 소셜
  SPECIAL       // 특별 이벤트
}

enum Rarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

model StudentAchievement {
  id            String      @id @default(cuid())
  studentId     String
  achievementId String
  student       Student     @relation(fields: [studentId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  unlockedAt    DateTime    @default(now())

  @@unique([studentId, achievementId])
}

model DailyGoal {
  id          String    @id @default(cuid())
  studentId   String
  student     Student   @relation(fields: [studentId], references: [id])

  date        DateTime  @db.Date

  // 목표
  targetProblems    Int   @default(10)
  targetMinutes     Int   @default(30)
  targetXP          Int   @default(100)

  // 달성
  completedProblems Int   @default(0)
  completedMinutes  Int   @default(0)
  earnedXP          Int   @default(0)

  isCompleted Boolean   @default(false)

  @@unique([studentId, date])
}

model Quest {
  id          String    @id @default(cuid())
  name        String
  description String
  type        QuestType

  // 조건
  condition   Json

  // 보상
  xpReward    Int
  coinReward  Int

  // 기간
  startDate   DateTime?
  endDate     DateTime?
  isActive    Boolean   @default(true)
}

enum QuestType {
  DAILY
  WEEKLY
  MONTHLY
  SPECIAL
}

// ==================== 과제 시스템 ====================

model Assignment {
  id          String    @id @default(cuid())
  classId     String
  class       Class     @relation(fields: [classId], references: [id])

  title       String
  description String?

  // 문제 설정
  conceptIds  String[]
  problemCount Int
  difficulty  Float?    // null이면 적응형

  // 기한
  dueDate     DateTime

  createdAt   DateTime  @default(now())
}

// ==================== 인증 관련 (NextAuth) ====================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
